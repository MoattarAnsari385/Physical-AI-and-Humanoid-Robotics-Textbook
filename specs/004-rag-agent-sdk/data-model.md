# Data Model: RAG Agent Development

## Entities

### Query Request
**Description**: Represents a user query request to the RAG agent system

**Fields**:
- `query` (string): The user's question or query text (required)
- `top_k` (integer): Number of top results to retrieve (optional, default: 5)
- `temperature` (float): Temperature parameter for agent response generation (optional, default: 0.7)
- `user_id` (string): Identifier for the user making the request (optional)
- `metadata` (dict): Additional metadata for the request (optional)

**Validation**:
- Query must not be empty or only whitespace
- top_k must be between 1 and 20
- temperature must be between 0.0 and 2.0

### Retrieved Context Chunk
**Description**: A single chunk of context retrieved from the vector database

**Fields**:
- `id` (string): Unique identifier for the chunk in the vector database
- `content` (string): The actual text content of the chunk
- `metadata` (dict): Associated metadata (URL, source document, position, etc.)
- `similarity_score` (float): Similarity score between query and chunk (0.0-1.0)
- `position` (integer): Position in the ranked results (0-indexed)

**Validation**:
- Content must not be empty
- Similarity score must be between 0.0 and 1.0
- Position must be non-negative

### Agent Response
**Description**: The final response generated by the OpenAI agent

**Fields**:
- `answer` (string): The agent's answer to the user's query
- `sources` (list[Retrieved Context Chunk]): List of source chunks used to generate the response
- `confidence` (float): Confidence score for the response (0.0-1.0)
- `processing_time` (float): Time taken to process the request in seconds
- `tokens_used` (dict): Token usage information (input_tokens, output_tokens, total_tokens)
- `timestamp` (datetime): When the response was generated

**Validation**:
- Answer must not be empty
- Confidence score must be between 0.0 and 1.0
- Processing time must be non-negative

### API Response
**Description**: The structured response returned by the FastAPI endpoint

**Fields**:
- `success` (boolean): Whether the request was processed successfully
- `data` (Agent Response): The agent response object (if successful)
- `error` (dict): Error information if the request failed (if unsuccessful)
- `request_id` (string): Unique identifier for the request for tracking purposes

**Validation**:
- Success field must be boolean
- Either data or error field must be present, not both

## Relationships

```
Query Request (1) → (Many) Retrieved Context Chunk (Many) → (1) Agent Response → (1) API Response
```

A single query request can result in multiple retrieved context chunks, which are then used to generate a single agent response, which is wrapped in an API response.

## State Transitions

### Agent Response States
- `PENDING`: Request received, agent not yet started processing
- `RETRIEVING`: Agent is calling retrieval tool to get context
- `PROCESSING`: Agent is generating response based on context
- `COMPLETED`: Agent response successfully generated
- `FAILED`: Error occurred during processing

### Processing Flow
```
PENDING → RETRIEVING → PROCESSING → COMPLETED
    ↓              ↓              ↓
  FAILED ←———————————— ←———————————— (with error details)
```

## Constraints

1. **Grounding Constraint**: Agent responses must only contain information present in the retrieved context chunks
2. **Token Limit**: Combined query and context must fit within the model's token limits
3. **Response Time**: Individual requests should complete within 5 seconds
4. **Confidence Threshold**: Responses with low confidence (<0.5) should acknowledge uncertainty
5. **Relevance Threshold**: Only context chunks with similarity scores above 0.3 should be used for response generation